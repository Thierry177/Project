<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Scheda Libro</title>

    <link rel="stylesheet" href="project.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
      main {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 40px;
      }

      .book-detail {
        display: flex;
        flex-direction: row;
        gap: 50px; /* più spazio tra immagine e info */
        max-width: 1100px;
        width: 100%;
        background: #f9f9f9;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0px 6px 14px rgba(0,0,0,0.15);
        margin: 0 auto;
      }

      .book-detail img {
        max-width: 380px; /* immagine più grande */
        height: auto;
        border-radius: 8px;
        object-fit: cover;
      }

      .book-info { 
        display: flex; 
        flex-direction: column; 
        gap: 20px; 
        flex: 1; 
        padding-left: 10px; /* sposta le scritte leggermente verso destra */
      }


      .book-info h2 { 
        margin: 0; 
        font-size: 34px; /* titolo più grande */
        color: #333; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
      }

      .book-info h2 img { 
        width: 40px; 
        height: 60px; 
        border-radius: 6px; 
        object-fit: cover; 
      }

      .author { font-size: 20px; color: #555; }
      .price { font-size: 26px; font-weight: bold; color: #222; }
      .book-description { font-size: 18px; line-height: 1.6; color: #444; }

      .btn-cart { 
        margin-top: 25px; 
        padding: 14px 24px; 
        background-color: #333; 
        color: #fff; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-size: 18px; 
        font-weight: bold;
        transition: background 0.3s; 
        width: fit-content; 
      }
      .btn-cart:hover { background-color: #555; }

      .book-section { max-width: 1100px; margin: 0 auto; }
      .book-section h3 {  
        background-color:#cecccc ;
        padding: 12px; 
        border-radius: 8px; 
        margin-bottom: 18px; 
        color: #0c0c0c; 
        font-size: 20px;
      }

      .book-slider {
        display: flex;
        gap: 18px;
        overflow-x: auto;
        padding: 12px 0;
        scroll-behavior: smooth;
      }
      .book-slider::-webkit-scrollbar { height: 6px; }
      .book-slider::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

      .book-card {
        min-width: 140px;
        max-width: 160px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        border-radius: 8px;
        padding: 10px;
        background-color: white;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .book-card:hover { transform: scale(1.05); box-shadow: 0px 4px 8px rgba(0,0,0,0.2); }

      .book-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 6px; }
      .book-title { margin-top: 6px; font-size: 15px; font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .book-price { font-size: 14px; color: #666; margin-top: 3px; }

      .tag { font-size: 11px; background: #105a3c; color: white; padding: 3px 7px; border-radius: 5px; margin-bottom: 4px; }
    </style>

  </head>

  <body>
    <nav>
      <!-- Sinistra -->
      <div class="nav-left">
        <ul class="nav-links">
          <li><a href="category.html?cat=Novità">Novità</a></li>

          <li class="dropdown">
            <a href="#" class="dropbtn" onclick="return false;">Categorie</a>
            <div class="dropdown-content">
              <div class="dropdown-col">
                <a href="category.html?cat=Narrativa">Narrativa</a>
                <a href="category.html?cat=Thriller">Giallo / Thriller</a>
                <a href="category.html?cat=Fantascienza">Fantascienza</a>
                <a href="category.html?cat=Fantasy">Fantasy</a>
                <a href="category.html?cat=Romanzo rosa">Romanzo rosa</a>
              </div>
              <div class="dropdown-col">
                <a href="category.html?cat=Storico">Storico</a>
                <a href="category.html?cat=Horror">Horror</a>
                <a href="category.html?cat=Biografie">Biografie</a>
                <a href="category.html?cat=Young Adult">Young Adult</a>
                <a href="category.html?cat=Classici">Classici</a>
              </div>
              <div class="dropdown-col">
                <a href="category.html?cat=Avventura">Avventura</a>
                <a href="category.html?cat=Umoristico">Umoristico</a>
                <a href="category.html?cat=Psicologico">Psicologico</a>
                <a href="category.html?cat=Distopico">Distopico</a>
                <a href="category.html?cat=Poesia">Poesia</a>
              </div>
            </div>
          </li>

          <li><a href="project.html">Chi siamo</a></li>
        </ul>
      </div>

      <!-- Centro -->
      <div class="logo">
        <a href="project.html">
          <img src="images/LOGO.png" alt="Logo Libreria" class="logo-img">
        </a>
      </div>


      <!-- Destra -->
      <div class="nav-right">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="Cerca...">
          <i id="search-button" class="fas fa-search" style="cursor:pointer;"></i>
        </div>
        <ul class="nav-icons">
          <li><a id="userLink" href="#"><i class="fas fa-user"></i></a></li>
          <li><a href="ordini.html">I miei ordini</a></li>
          <li><a href="carrello.html"><i class="fas fa-shopping-cart"></i></a></li>
        </ul>
      </div>
    </nav>

    <div class="content-layout">

      <main>
        <div class="book-detail">
          <img id="book-image" src="default.jpg" alt="Copertina libro">
          <div class="book-info">
            <h2>
              <img id="book-mini" src="default.jpg" alt="Miniatura">
              <span id="book-title">Caricamento...</span>
            </h2>
            <div class="author" id="book-author"></div>
            <div class="price" id="book-price"></div>
            <div class="book-description" id="book-description"></div>
            <button id="add-to-cart" class="btn-cart">
              <i class="fas fa-cart-plus"></i> Aggiungi al carrello
            </button>
          </div>
        </div>

        <div class="book-section">
          <h3>Potrebbe piacerti anche</h3>
          <div class="book-slider" id="related-books"></div>
        </div>
      </main>
    </div>

    <footer>
      <div class="footer-container">
        <p>&copy; 2025 La tua Libreria Online</p>
        <p>
          <a href="#">Termini</a> |
          <a href="#">Privacy</a> |
          <a href="#">Contatti</a>
        </p>
        <p>
          <a href="#"><i class="fab fa-facebook"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
        </p>
      </div>
    </footer>
    
    <script src="search-bar.js"></script>
    <script src="user-icon.js"></script>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      const userId = user ? user.id : null;

      let currentBook = null;
      let categorie = [];

      async function loadBook() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        if (!id) {
          document.querySelector("main").innerHTML = "<p>Nessun libro selezionato</p>";
          return;
        }

        try {
          // 1. Recupera tutte le categorie
          const categorieRes = await fetch("/api/categorie");
          categorie = await categorieRes.json();

          // 2. Recupera il libro selezionato
          const res = await fetch(`/api/libri/${id}`);
          const libro = await res.json();

          if (libro.error) {
            document.querySelector("main").innerHTML = "<p>Libro non trovato</p>";
            return;
          }

          currentBook = libro;

          document.getElementById("book-image").src = libro.immagine_url || "default.jpg";
          document.getElementById("book-mini").src = libro.immagine_url || "default.jpg";
          document.getElementById("book-title").textContent = libro.titolo;
          document.getElementById("book-author").textContent = "di " + libro.autore;
          document.getElementById("book-price").textContent = "€" + libro.prezzo;
          document.getElementById("book-description").innerHTML = `<p>${libro.descrizione}</p>`;

          // 3. Libri correlati
          const resCorrelati = await fetch(`/api/categorie/${libro.categoria_id}/libri`);
          const correlati = await resCorrelati.json();

          const slider = document.getElementById("related-books");
          slider.innerHTML = "";

          correlati
            .filter(b => b.id_libro !== libro.id_libro)
            .forEach(b => {
              // trova il nome della categoria
              const cat = categorie.find(c => c.id_categoria === b.categoria_id);
              const catNome = cat ? cat.nome : "Sconosciuta";

              const card = document.createElement("a");
              card.href = `libri.html?id=${b.id_libro}`;
              card.className = "book-card";
              card.innerHTML = `
                <span class="tag">${catNome}</span>
                <img src="${b.immagine_url || "default.jpg"}" alt="">
                <div class="book-title">${b.titolo}</div>
                <div class="book-price">€${b.prezzo}</div>
              `;
              slider.appendChild(card);
            });

        } catch (err) {
          console.error("Errore caricamento libro:", err);
        }
      }

      async function addToCart() {
        if (!currentBook) return;

        // Se NON sei loggato, salva in localStorage
        if (!userId) {
          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          // evita duplicati
          if (!cart.find(b => b.id_libro === currentBook.id_libro)) {
            cart.push(currentBook);
            localStorage.setItem("cart", JSON.stringify(cart));
          }
          alert("Libro aggiunto al carrello");
          window.location.href = "carrello.html";
          return;
        }

        // Se sei loggato, salva nel backend
        try {
          const res = await fetch(`/api/carrello/${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_libro: currentBook.id_libro })
          });

          const data = await res.json();
          alert(data.message || "Libro aggiunto al carrello");
          window.location.href = "carrello.html";
        } catch (err) {
          console.error("Errore aggiunta al carrello:", err);
        }
      }


      document.addEventListener("DOMContentLoaded", () => {
        loadBook();
        document.getElementById("add-to-cart").addEventListener("click", addToCart);
      });
    </script>

    
  </body>
</html>

